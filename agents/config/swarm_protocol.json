{
  "protocol_name": "Morphism Swarm Protocol",
  "version": "4.4",
  "description": "Agent Team 协调与通信协议 (v4.4: 合并Lead+Broadcaster，第一轮信息流分层)",
  "modes": {
    "fast": {
      "description": "单函子映射模式（v4.4 兼容）",
      "flow": [
        "Phase 0: Category Extraction (Team Lead)",
        "Phase 1: Domain Selection (domain_selector.py)",
        "Phase 2: Functorial Mapping (单个 Domain Agent)",
        "Phase 3: Pull-back & Synthesis (生成提案)"
      ],
      "trigger": "默认启动"
    },
    "swarm": {
      "description": "函子范畴蜂群模式（v4.4 升级）",
      "flow": [
        "Phase 0: Category Extraction (Team Lead - 原Broadcaster职责)",
        "Phase 1: Domain Selection (Fast Mode 预筛选 3-5 个种子)",
        "Phase 2: Agent Swarm Exploration",
        "  2.1: Team Lead 范畴骨架注入 → Domain Agents",
        "  2.2: Round 1: Domain Agents 双发送",
        "    - MAPPING_RESULT_ROUND1 → Obstruction (完整)",
        "    - MAPPING_BRIEF → Synthesizer (一句话)",
        "  2.3: Obstruction 审查",
        "    - OBSTRUCTION_FEEDBACK → Domain Agent (完整反馈)",
        "    - OBSTRUCTION_DIAGNOSIS → Synthesizer (30字风险)",
        "  2.4: Round 2+: Domain Agents → Synthesizer (完整)",
        "  2.5: Natural Transformation (Agents 两两通信检测同构)",
        "  2.6: Cluster Formation (形成同构簇)",
        "  2.7: Synthesis (Synthesizer 计算 Limit/Colimit)",
        "  2.8: Knowledge Update (更新图谱和日志)"
      ],
      "trigger": [
        "用户明确请求",
        "Fast Mode 置信度 < 70%",
        "关键词匹配: 突破/创新/换个视角/复杂问题"
      ]
    }
  },
  "message_types": {
    "CATEGORY_SKELETON": {
      "from": "Team Lead",
      "to": "Domain Agents",
      "purpose": "v4.4: Team Lead发送范畴骨架（原Broadcaster职责）",
      "schema": {
        "type": "CATEGORY_SKELETON",
        "timestamp": "ISO8601",
        "payload": {
          "objects": "核心实体列表",
          "morphisms": "动态关系列表",
          "structural_tags": "16个动态标签",
          "user_profile": "用户画像",
          "exploration_mode": "swarm"
        }
      }
    },
    "MAPPING_RESULT_ROUND1": {
      "from": "Domain Agent",
      "to": "Obstruction Theorist",
      "purpose": "v4.4: 第一轮完整映射结果，发送给Obstruction审查",
      "schema": {
        "type": "MAPPING_RESULT_ROUND1",
        "agent_id": "域名",
        "timestamp": "ISO8601",
        "payload": {
          "domain": "领域名称",
          "mapping_result": {
            "objects": "对象映射",
            "morphisms": "态射映射",
            "theorems": "选用的定理",
            "core_insight": "核心洞察",
            "kernel_loss": "核损耗分析",
            "verification_proof": "验证证明"
          }
        }
      }
    },
    "MAPPING_BRIEF": {
      "from": "Domain Agent",
      "to": "Synthesizer",
      "purpose": "v4.4: 第一轮一句话核心洞察，发送给Synthesizer",
      "schema": {
        "type": "MAPPING_BRIEF",
        "agent_id": "域名",
        "timestamp": "ISO8601",
        "payload": {
          "domain": "领域名称",
          "core_insight": "一句话核心洞察（max 50字）"
        }
      }
    },
    "OBSTRUCTION_FEEDBACK": {
      "from": "Obstruction Theorist",
      "to": "Domain Agent",
      "purpose": "v4.4: Obstruction完整审查反馈，返回给Domain Agent",
      "schema": {
        "type": "OBSTRUCTION_FEEDBACK",
        "timestamp": "ISO8601",
        "payload": {
          "domain": "领域名称",
          "assessment": {
            "dynamics_test": {
              "passed": "boolean",
              "issues": "问题列表"
            },
            "constraints_test": {
              "passed": "boolean",
              "issues": "问题列表"
            },
            "side_effects_test": {
              "passed": "boolean",
              "issues": "问题列表"
            }
          },
          "overall_verdict": "PASS | HIGH_RISK | LOW_RISK",
          "correction_requests": "修正建议列表"
        }
      }
    },
    "OBSTRUCTION_DIAGNOSIS": {
      "from": "Obstruction Theorist",
      "to": "Synthesizer",
      "purpose": "v4.4: Obstruction 30字风险预警，发送给Synthesizer",
      "schema": {
        "type": "OBSTRUCTION_DIAGNOSIS",
        "timestamp": "ISO8601",
        "payload": {
          "domain": "领域名称",
          "diagnosis": "30字风险预警（max 30字）",
          "risk_level": "HIGH | MEDIUM | LOW"
        }
      }
    },
    "MAPPING_RESULT": {
      "from": "Domain Agent",
      "to": "Synthesizer",
      "purpose": "第二轮及后续完整映射结果",
      "schema": {
        "type": "MAPPING_RESULT",
        "agent_id": "域名",
        "timestamp": "ISO8601",
        "payload": {
          "domain": "领域名称",
          "round": "轮次号（2+）",
          "mapping_result": {
            "完整映射结果": "..."
          },
          "changes_from_round1": "修正说明"
        }
      }
    },
    "ADHOC_REVIEW_REQUEST": {
      "from": "Synthesizer",
      "to": "Obstruction Theorist",
      "purpose": "v4.4: Synthesizer按需审查请求",
      "schema": {
        "type": "ADHOC_REVIEW_REQUEST",
        "timestamp": "ISO8601",
        "payload": {
          "domain": "领域名称",
          "reason": "请求原因",
          "focus_areas": "重点审查方面",
          "mapping_result": "该Domain的完整映射结果"
        }
      }
    },
    "ADHOC_DIAGNOSIS": {
      "from": "Obstruction Theorist",
      "to": "Synthesizer",
      "purpose": "v4.4: Obstruction按需深度诊断",
      "schema": {
        "type": "ADHOC_DIAGNOSIS",
        "timestamp": "ISO8601",
        "payload": {
          "domain": "领域名称",
          "specific_issue": "响应具体问题",
          "deep_analysis": "深度分析结果",
          "recommendation": "建议保留/替换/修正"
        }
      }
    },
    "HOMOGRAPHY_PROBE": {
      "from": "Domain Agent",
      "to": "另一个 Domain Agent",
      "purpose": "探测结构同构",
      "schema": {
        "type": "HOMOGRAPHY_PROBE",
        "message_id": "唯一ID",
        "timestamp": "ISO8601",
        "payload": {
          "my_observation": "我的观察",
          "formal_structure": "形式化结构（自然语言）",
          "formal_structure_signature": "符号化表达（伪代码）",
          "query": "你领域有对应结构吗？",
          "examples": [
            "A -> B -> A' (Feedback Loop)",
            "X + Y -> Z (Composition)",
            "d/dt(A) = f(B) (Dynamics)"
          ]
        }
      }
    },
    "HOMOGRAPHY_CONFIRM": {
      "from": "Domain Agent",
      "to": "发起探测的 Agent",
      "purpose": "确认结构同构（带验证证明）",
      "schema": {
        "type": "HOMOGRAPHY_CONFIRM",
        "message_id": "唯一ID",
        "in_reply_to": "原始消息ID",
        "timestamp": "ISO8601",
        "payload": {
          "matched": true,
          "corresponding_structure": "对应结构",
          "formal_mapping": "形式化映射",
          "isomorphism_type": "同构类型",
          "confidence": "0-1",
          "verification_proof": {
            "description": "双点验证：证明映射的一致性",
            "if_then_logic": "如果 Domain A 的 [X] 映射为 Domain B 的 [Y]，那么 Domain A 的 [X'] 必须对应 Domain B 的 [Y']",
            "examples": [
              {
                "domain_a_element": "熵增 (dS/dt > 0)",
                "domain_b_element": "噪声增加 (H(X|Y) 上升)",
                "verification": "熵增导致混乱度增加 ↔ 噪声导致信息丢失，两者都是'不可逆的无序化过程'"
              }
            ]
          }
        }
      }
    },
    "HOMOGRAPHY_REJECT": {
      "from": "Domain Agent",
      "to": "发起探测的 Agent",
      "purpose": "拒绝同构探测",
      "schema": {
        "type": "HOMOGRAPHY_REJECT",
        "message_id": "唯一ID",
        "in_reply_to": "原始消息ID",
        "timestamp": "ISO8601",
        "payload": {
          "matched": false,
          "reason": "拒绝原因"
        }
      }
    },
    "CLUSTER_REPORT": {
      "from": "Synthesizer",
      "to": "所有 Agents",
      "purpose": "广播同构簇形成",
      "schema": {
        "type": "CLUSTER_REPORT",
        "timestamp": "ISO8601",
        "payload": {
          "cluster_id": "簇ID",
          "members": "成员列表",
          "shared_structure": "共享结构",
          "collective_confidence": "集体置信度"
        }
      }
    },
    "DECISION_MEETING": {
      "from": "Team Lead",
      "to": ["Synthesizer", "Obstruction Theorist"],
      "purpose": "v4.4: 三人小组决策会议召集",
      "schema": {
        "type": "DECISION_MEETING",
        "timestamp": "ISO8601",
        "payload": {
          "agenda": "评估是否启动新一轮迭代",
          "round": "当前轮次"
        }
      }
    }
  },
  "timeout_settings": {
    "agent_mapping_timeout": 30,
    "obstruction_review_timeout": 20,
    "probe_response_timeout": 15,
    "total_swarm_timeout": 300,
    "description": "秒，超时后强制继续"
  },
  "fault_tolerance": {
    "allow_partial_failure": true,
    "min_working_agents": 2,
    "fallback_to_fast": "当 < 2 个 Agents 响应时回退到 Fast Mode"
  },
  "koan_break": {
    "triggers": [
      "所有 confidence_score < 50",
      "超时且无有效结果"
    ],
    "strategy": "渐进降级",
    "phase_1": {
      "name": "概念泛化",
      "description": "将具体概念泛化为更抽象的概念重试",
      "examples": [
        "耗散结构 → 系统",
        "信号博弈 → 互动",
        "关键创新 → 突破"
      ]
    },
    "phase_2": {
      "name": "建议新领域",
      "description": "向用户报告部分发现，建议引入新领域",
      "user_interaction": "用户确认后动态启动新 Agent"
    }
  },
  "seed_selection": {
    "method": "fast_mode_first",
    "fallback": "default_seed_domains",
    "adaptive": {
      "enabled": true,
      "source": "knowledge_graph_recommendations",
      "description": "基于知识图谱的历史成功率调整种子选择"
    },
    "wildcard_agent": {
      "enabled": true,
      "description": "随机引入 1 个不相关领域，增加发现非共识创新的概率",
      "selection_method": "随机从 non_default_seed_domains 中选择",
      "probability": 1.0,
      "rationale": "引入随机扰动（Stochasticity），防止在局部极值中打转"
    }
  },
  "quality_metrics": {
    "limit_quality": "基于参与领域数量 × 平均置信度",
    "colimit_quality": "基于互补性评分 × 可执行性",
    "overall_swarm_success": "Limit + Colimit 综合评分 > 70"
  },
  "v4.4_features": {
    "first_round_dual_send": "第一轮双发送：Obstruction完整 + Synthesizer一句话",
    "obstruction_30char_diagnosis": "Obstriction 30字风险预警",
    "on_demand_obstruction": "Synthesizer按需调用Obstruction",
    "three_person_decision": "三人小组决策会议（禁止单方面终止）",
    "leader_category_extraction": "Team Lead负责范畴提取（原Broadcaster职责）"
  }
}
